# 1. Docker Compose のファイルバージョンを定義
version: '3.9'

# 2. 各サービスを定義
services:
  db:
		# a. コンテナの出所 + コンテナ名 image, build
    image: mysql:8.0
    container_name: mysql_db
		# b. 実行環境の設定 env_file, command
    environment:
		# ルートパスワードとアプリのユーザー名・パスワード・データベースを定義
      MYSQL_ROOT_PASSWORD: your_secure_root_password
      MYSQL_USER: memo_app_user
      MYSQL_PASSWORD: memo_app_password
      MYSQL_DATABASE: memo_app_db
		
		# b. 実行環境の設定（※ environmentとは別の親キーとして定義が必要）
    # 常に再起動するように設定
    restart: always 
      
		# c. 永続化とリソース（I/O）: 外部やホストとどう連携するか？
    volumes:
      - db_data:/var/lib/mysql
		
		# d. 依存関係とネットワーク、健全性: 他のサービスやネットワークとどう関わるか？
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u$$MYSQL_USER", "-p$$MYSQL_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
		
  web:
		# a. コンテナの出所 + コンテナ名 image, build
    build: .
    container_name: flask_app
		# b. 実行環境の設定 env_file, command
    environment:
      # アプリがDBに接続するための情報を環境変数として渡す
      DB_HOST: db
      DB_USER: memo_app_user
      DB_PASSWORD: memo_app_password
      DB_NAME: memo_app_db
    
    # c. 永続化とリソース（I/O）: 外部やホストとどう連携するか？（※ environmentとは別の親キーとして定義が必要）
    # ホストPCのポートをコンテナ内のポートにマッピング
    ports:
      - "5000:5000"

    # b. 実行環境の設定（※ environmentとは別の親キーとして定義が必要）
    # コンテナの標準入出力を維持する設定
    tty: true

		# c. 永続化とリソース（I/O）: 外部やホストとどう連携するか？
    volumes:
      - .:/app
		# d. 依存関係とネットワーク、健全性: 他のサービスやネットワークとどう関わるか？
    depends_on:
      db:
        # dbサービスがHEALTHYになるまで待つ
        condition: service_healthy
		
# 3. 永続化のためのボリューム定義 (トップレベル) volumes
volumes:
  db_data:
# 4. 依存関係とネットワーク (トップレベル) networks